<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoNetwork</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-card: #111111;
            --bg-card-hover: #1a1a1a;
            --bg-elevated: #1c1c1e;
            --bg-input: #1c1c1e;
            --border: rgba(255,255,255,0.08);
            --border-hover: rgba(255,255,255,0.15);
            --border-focus: #7c3aed;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #52525b;
            --accent: #7c3aed;
            --accent-light: #a78bfa;
            --accent-glow: rgba(124, 58, 237, 0.15);
            --accent-glow-strong: rgba(124, 58, 237, 0.3);
            --green: #10b981;
            --red: #f43f5e;
            --red-glow: rgba(244, 63, 94, 0.15);
            --blue: #3b82f6;
            --gradient-brand: linear-gradient(135deg, #7c3aed 0%, #ec4899 100%);
            --gradient-card: linear-gradient(145deg, rgba(124,58,237,0.05) 0%, rgba(236,72,153,0.03) 100%);
            --gradient-accent: linear-gradient(135deg, #7c3aed, #6d28d9);
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
            --shadow-glow: 0 0 24px rgba(124,58,237,0.15);
            --radius: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --radius-full: 9999px;
            --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        ::selection {
            background: var(--accent);
            color: #fff;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        a { color: var(--accent-light); text-decoration: none; transition: color var(--transition); }
        a:hover { color: var(--accent); }

        /* ============ LAYOUT ============ */
        .layout {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
        }

        /* ============ NAVBAR ============ */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.72);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 0 16px;
            height: 53px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 22px;
            font-weight: 900;
            cursor: pointer;
            background: var(--gradient-brand);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: -0.5px;
            user-select: none;
        }

        .nav-right {
            display: flex;
            gap: 2px;
            align-items: center;
        }

        .nav-btn {
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px 14px;
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 500;
            transition: all var(--transition);
            border: none;
            background: transparent;
            white-space: nowrap;
        }
        .nav-btn:hover {
            color: var(--text-primary);
            background: rgba(255,255,255,0.06);
        }
        .nav-btn.active {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* ============ TABS ============ */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }
        .tab {
            flex: 1;
            padding: 14px 0;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: all var(--transition);
            position: relative;
            border: none;
            background: transparent;
        }
        .tab:hover { color: var(--text-secondary); background: rgba(255,255,255,0.03); }
        .tab.active {
            color: var(--text-primary);
            font-weight: 700;
        }
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 56px;
            height: 3px;
            background: var(--gradient-brand);
            border-radius: 3px 3px 0 0;
        }

        /* ============ CARDS ============ */
        .card {
            border-bottom: 1px solid var(--border);
            padding: 16px;
            transition: background var(--transition);
            animation: fadeSlide 0.4s ease forwards;
            opacity: 0;
        }
        .card:hover { background: rgba(255,255,255,0.02); }

        .card:nth-child(1) { animation-delay: 0s; }
        .card:nth-child(2) { animation-delay: 0.03s; }
        .card:nth-child(3) { animation-delay: 0.06s; }
        .card:nth-child(4) { animation-delay: 0.09s; }
        .card:nth-child(5) { animation-delay: 0.12s; }

        .card-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            margin: 16px;
            box-shadow: var(--shadow-md);
        }

        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============ FORMS ============ */
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
        }
        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            transition: all var(--transition);
        }
        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        .form-input::placeholder { color: var(--text-muted); }

        textarea.form-input {
            resize: vertical;
            min-height: 80px;
            line-height: 1.6;
        }

        /* ============ BUTTONS ============ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            font-family: inherit;
            transition: all var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }
        .btn:active { transform: scale(0.96); }

        .btn-primary {
            background: var(--text-primary);
            color: var(--bg-primary);
        }
        .btn-primary:hover {
            background: #d4d4d8;
        }

        .btn-accent {
            background: var(--gradient-brand);
            color: #fff;
            box-shadow: 0 2px 12px var(--accent-glow-strong);
        }
        .btn-accent:hover {
            box-shadow: 0 4px 20px var(--accent-glow-strong);
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        .btn-outline:hover {
            border-color: var(--border-hover);
            background: rgba(255,255,255,0.04);
        }

        .btn-danger {
            background: var(--red);
            color: #fff;
        }

        .btn-sm {
            padding: 6px 16px;
            font-size: 13px;
        }

        .btn-block { width: 100%; }

        /* Follow button */
        .btn-follow {
            padding: 8px 20px;
            border: none;
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            font-family: inherit;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .btn-follow.follow {
            background: var(--text-primary);
            color: var(--bg-primary);
        }
        .btn-follow.follow:hover {
            transform: scale(1.05);
            background: #d4d4d8;
        }
        .btn-follow.following {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        .btn-follow.following:hover {
            border-color: var(--red);
            color: var(--red);
            background: var(--red-glow);
        }

        /* ============ POST ============ */
        .post { display: flex; gap: 12px; }
        .post-left { flex-shrink: 0; }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-brand);
            object-fit: cover;
            cursor: pointer;
            transition: opacity var(--transition);
        }
        .avatar:hover { opacity: 0.85; }

        .avatar-sm { width: 28px; height: 28px; border-radius: 50%; background: var(--gradient-accent); object-fit: cover; }

        .avatar-lg {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--bg-primary);
            box-shadow: 0 0 0 1px var(--border);
        }
        .avatar-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: #fff;
            font-size: 18px;
            user-select: none;
        }
        .avatar-placeholder.lg {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            font-size: 36px;
            background: var(--gradient-brand);
            border: 3px solid var(--bg-primary);
            box-shadow: 0 0 0 1px var(--border), 0 0 40px var(--accent-glow);
        }

        .post-right { flex: 1; min-width: 0; }

        .post-header {
            display: flex;
            align-items: center;
            gap: 6px;
            line-height: 1.3;
        }

        .post-name {
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: color var(--transition);
        }
        .post-name:hover { color: var(--accent-light); }

        .post-handle {
            color: var(--text-muted);
            font-size: 14px;
        }

        .post-dot {
            color: var(--text-muted);
            font-size: 14px;
        }

        .post-time {
            color: var(--text-muted);
            font-size: 14px;
            transition: color var(--transition);
        }
        .post-time:hover { color: var(--accent-light); text-decoration: underline; }

        .post-content {
            margin-top: 4px;
            line-height: 1.55;
            font-size: 15px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .post-image {
            width: 100%;
            max-height: 500px;
            object-fit: cover;
            border-radius: var(--radius-md);
            margin-top: 12px;
            cursor: pointer;
            border: 1px solid var(--border);
            transition: opacity var(--transition);
        }
        .post-image:hover { opacity: 0.92; }

        .post-actions {
            display: flex;
            gap: 0;
            margin-top: 12px;
            margin-left: -8px;
        }

        .post-delete-btn {
            margin-left: auto;
            color: var(--text-muted);
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: all var(--transition);
            font-size: 18px;
            line-height: 1;
            border: none;
            background: transparent;
        }
        .post-delete-btn:hover { color: var(--red); background: var(--red-glow); }

        /* Action buttons */
        .action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: var(--radius-full);
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            border: none;
            background: transparent;
            font-family: inherit;
        }
        .action-btn:hover { background: rgba(255,255,255,0.06); }

        .action-btn.like:hover { color: var(--red); background: var(--red-glow); }
        .action-btn.like.liked { color: var(--red); }

        .action-btn.comment:hover { color: var(--blue); background: rgba(59,130,246,0.1); }

        .action-btn svg { width: 18px; height: 18px; transition: transform 0.15s ease; }

        @keyframes heartPop {
            0% { transform: scale(1); }
            15% { transform: scale(1.3); }
            30% { transform: scale(0.85); }
            50% { transform: scale(1.15); }
            75% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        .action-btn.animate svg { animation: heartPop 0.5s ease; }

        /* ============ COMPOSE ============ */
        .compose {
            display: flex;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .compose-right { flex: 1; }

        .compose textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 18px;
            font-family: inherit;
            resize: none;
            min-height: 52px;
            line-height: 1.4;
            padding: 4px 0;
        }
        .compose textarea:focus { outline: none; }
        .compose textarea::placeholder { color: var(--text-muted); }

        .compose-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .compose-actions { display: flex; gap: 4px; }

        .compose-icon {
            cursor: pointer;
            color: var(--accent);
            padding: 8px;
            border-radius: 50%;
            transition: all var(--transition);
            display: flex;
            align-items: center;
        }
        .compose-icon:hover { background: var(--accent-glow); }
        .compose-icon svg { width: 20px; height: 20px; }

        .image-preview {
            position: relative;
            margin-top: 12px;
            display: none;
        }
        .image-preview img {
            max-height: 260px;
            border-radius: var(--radius-md);
            object-fit: cover;
            border: 1px solid var(--border);
        }
        .image-preview .remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.75);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        /* ============ PROFILE ============ */
        .profile-banner {
            height: 150px;
            background: var(--gradient-brand);
            position: relative;
        }

        .profile-info {
            padding: 0 16px 16px;
            position: relative;
        }

        .profile-avatar-wrap {
            margin-top: -48px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 800;
            line-height: 1.2;
        }

        .profile-handle {
            color: var(--text-muted);
            font-size: 14px;
            margin-top: 1px;
        }

        .profile-bio {
            margin-top: 12px;
            font-size: 15px;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        .profile-stats-row {
            display: flex;
            gap: 20px;
            margin-top: 12px;
        }
        .profile-stat {
            font-size: 14px;
            color: var(--text-muted);
            cursor: pointer;
            transition: color var(--transition);
        }
        .profile-stat:hover { text-decoration: underline; color: var(--text-secondary); }
        .profile-stat strong {
            color: var(--text-primary);
            font-weight: 700;
        }

        /* ============ AUTH PAGES ============ */
        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 48px 24px;
        }

        .auth-logo {
            font-size: 32px;
            font-weight: 900;
            background: var(--gradient-brand);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-align: center;
            margin-bottom: 8px;
        }

        .auth-title {
            font-size: 28px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 8px;
        }

        .auth-subtitle {
            text-align: center;
            color: var(--text-muted);
            font-size: 15px;
            margin-bottom: 32px;
        }


        .auth-footer {
            text-align: center;
            margin-top: 24px;
            font-size: 14px;
            color: var(--text-muted);
        }

        /* ============ COMMENTS ============ */
        .comment {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .comment:last-child { border-bottom: none; }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        /* ============ USER LIST ============ */
        .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background var(--transition);
        }
        .user-item:hover { background: rgba(255,255,255,0.03); }

        /* ============ UTILITIES ============ */
        .spinner-wrap {
            display: flex;
            justify-content: center;
            padding: 48px 20px;
        }
        .spinner-ring {
            width: 28px; height: 28px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .back-bar {
            display: flex;
            align-items: center;
            gap: 24px;
            padding: 0 16px;
            height: 53px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 53px;
            z-index: 50;
            background: rgba(0,0,0,0.72);
            backdrop-filter: saturate(180%) blur(20px);
        }
        .back-btn {
            cursor: pointer;
            color: var(--text-primary);
            padding: 8px;
            border-radius: 50%;
            transition: all var(--transition);
            display: flex;
            border: none;
            background: transparent;
        }
        .back-btn:hover { background: rgba(255,255,255,0.08); }
        .back-bar-info h3 { font-size: 16px; font-weight: 700; }
        .back-bar-info span { font-size: 13px; color: var(--text-muted); }

        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: var(--text-muted);
            font-size: 15px;
        }

        .page-title {
            font-size: 18px;
            font-weight: 800;
            padding: 16px;
        }

        .message {
            padding: 12px 16px;
            border-radius: var(--radius-md);
            margin: 16px;
            font-size: 14px;
            animation: fadeSlide 0.3s ease;
        }
        .message-error { background: var(--red-glow); border: 1px solid rgba(244,63,94,0.3); color: var(--red); }
        .message-success { background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); color: var(--green); }

        .hidden { display: none !important; }

        /* Lightbox */
        .lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.92);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: zoom-out;
            animation: fadeIn 0.2s;
            backdrop-filter: blur(8px);
        }
        .lightbox img {
            max-width: 92vw;
            max-height: 92vh;
            border-radius: var(--radius-md);
            object-fit: contain;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: var(--bg-elevated);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

    </style>
</head>
<body>

<div class="layout">
    <nav class="navbar">
        <span class="logo" onclick="navigate('#/')">GoNetwork</span>
        <div class="nav-right" id="navLinks"></div>
    </nav>
    <main id="app"></main>
</div>

<script>
    const API = '/v1';
    let accessToken = localStorage.getItem('access_token') || '';
    let refreshToken = localStorage.getItem('refresh_token') || '';
    let currentUser = JSON.parse(localStorage.getItem('current_user') || 'null');

    // === SVG ICONS ===
    const ICONS = {
        heart: (filled) => filled
            ? `<svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="currentColor"/></svg>`
            : `<svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>`,
        comment: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/></svg>`,
        image: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>`,
        back: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>`,
    };

    // === HTTP ===
    async function api(method, path, body = null) {
        const opts = { method, headers: { 'Content-Type': 'application/json' } };
        if (accessToken) opts.headers['Authorization'] = 'Bearer ' + accessToken;
        if (body) opts.body = JSON.stringify(body);

        let resp = await fetch(API + path, opts);

        if (resp.status === 401 && refreshToken) {
            const rr = await fetch(API + '/auth/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refresh_token: refreshToken }),
            });
            if (rr.ok) {
                const t = await rr.json();
                setTokens(t.access_token, t.refresh_token);
                opts.headers['Authorization'] = 'Bearer ' + accessToken;
                resp = await fetch(API + path, opts);
            } else { doLogout(); return null; }
        }
        return resp;
    }

    async function apiUpload(path, formData) {
        const opts = { method: 'POST', headers: {} };
        if (accessToken) opts.headers['Authorization'] = 'Bearer ' + accessToken;
        opts.body = formData;
        return fetch(API + path, opts);
    }

    function setTokens(a, r) {
        accessToken = a; refreshToken = r;
        localStorage.setItem('access_token', a);
        localStorage.setItem('refresh_token', r);
    }

    function setUser(u) {
        currentUser = u;
        localStorage.setItem('current_user', JSON.stringify(u));
    }

    // === ROUTING ===
    function navigate(hash) { window.location.hash = hash; }
    function getRoute() { return (window.location.hash || '#/').slice(1); }

    async function router() {
        const p = getRoute();
        updateNav();

        if (p === '/' || p === '/feed' || p === '') showFeed();
        else if (p === '/following') showFollowingFeed();
        else if (p === '/login') showLogin();
        else if (p === '/register') showRegister();
        else if (p.startsWith('/profile/')) { const id = parseInt(p.split('/')[2]); if (id) showProfile(id); }
        else if (p.startsWith('/followers/')) { const id = parseInt(p.split('/')[2]); if (id) showUserList(id, 'followers'); }
        else if (p.startsWith('/following/')) { const id = parseInt(p.split('/')[2]); if (id) showUserList(id, 'following'); }
        else if (p.startsWith('/comments/')) { const id = parseInt(p.split('/')[2]); if (id) showComments(id); }
        else if (p === '/edit-profile') showEditProfile();
        else showFeed();
    }

    window.addEventListener('hashchange', router);

    // === NAV ===
    function updateNav() {
        const nav = document.getElementById('navLinks');
        const route = getRoute();
        if (currentUser) {
            nav.innerHTML = `
                <button class="nav-btn ${route === '/' || route === '/feed' || route === '' ? 'active' : ''}" onclick="navigate('#/feed')">Лента</button>
                <button class="nav-btn ${route === '/following' ? 'active' : ''}" onclick="navigate('#/following')">Подписки</button>
                <button class="nav-btn" onclick="navigate('#/profile/${currentUser.id}')">
                    ${currentUser.avatar_url
                        ? `<img src="${currentUser.avatar_url}" style="width:28px;height:28px;border-radius:50%;object-fit:cover;vertical-align:middle">`
                        : esc(currentUser.username)}
                </button>
                <button class="nav-btn" onclick="doLogout()">Выйти</button>
            `;
        } else {
            nav.innerHTML = `
                <button class="nav-btn" onclick="navigate('#/login')">Войти</button>
                <button class="nav-btn btn-accent" style="padding:8px 20px" onclick="navigate('#/register')">Регистрация</button>
            `;
        }
    }

    // === PAGES ===

    function showLogin() {
        app.innerHTML = `
            <div class="auth-container">
                <div class="auth-logo">GoNetwork</div>
                <h1 class="auth-title">С возвращением</h1>
                <p class="auth-subtitle">Войдите в свой аккаунт</p>
                <div id="msg"></div>

                <div class="form-group">
                    <label>Email</label>
                    <input class="form-input" type="email" id="loginEmail" placeholder="you@example.com" onkeydown="if(event.key==='Enter')doLogin()">
                </div>
                <div class="form-group">
                    <label>Пароль</label>
                    <input class="form-input" type="password" id="loginPassword" placeholder="Ваш пароль" onkeydown="if(event.key==='Enter')doLogin()">
                </div>
                <button class="btn btn-primary btn-block" onclick="doLogin()">Войти</button>

                <p class="auth-footer">Нет аккаунта? <a href="#/register">Создать аккаунт</a></p>
            </div>
        `;
    }

    function showRegister() {
        app.innerHTML = `
            <div class="auth-container">
                <div class="auth-logo">GoNetwork</div>
                <h1 class="auth-title">Присоединяйтесь</h1>
                <p class="auth-subtitle">Создайте свой аккаунт прямо сейчас</p>
                <div id="msg"></div>

                <div class="form-group">
                    <label>Имя пользователя</label>
                    <input class="form-input" type="text" id="regUsername" placeholder="username">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input class="form-input" type="email" id="regEmail" placeholder="you@example.com">
                </div>
                <div class="form-group">
                    <label>Пароль</label>
                    <input class="form-input" type="password" id="regPassword" placeholder="Минимум 6 символов" onkeydown="if(event.key==='Enter')doRegister()">
                </div>
                <button class="btn btn-primary btn-block" onclick="doRegister()">Создать аккаунт</button>

                <p class="auth-footer">Уже есть аккаунт? <a href="#/login">Войти</a></p>
            </div>
        `;
    }

    async function showFeed() {
        // Show tabs + loading
        app.innerHTML = `
            <div class="tabs">
                <button class="tab active" onclick="navigate('#/feed')">Для вас</button>
                <button class="tab" onclick="navigate('#/following')">Подписки</button>
            </div>
            <div class="spinner-wrap"><div class="spinner-ring"></div></div>
        `;

        const resp = await api('GET', '/feed');
        if (!resp) return;
        const posts = await resp.json();

        let html = `
            <div class="tabs">
                <button class="tab active" onclick="navigate('#/feed')">Для вас</button>
                <button class="tab" onclick="navigate('#/following')">Подписки</button>
            </div>
        `;

        if (currentUser) {
            html += renderCompose();
        }
        html += renderPosts(posts);
        app.innerHTML = html;
    }

    async function showFollowingFeed() {
        if (!currentUser) { navigate('#/login'); return; }

        app.innerHTML = `
            <div class="tabs">
                <button class="tab" onclick="navigate('#/feed')">Для вас</button>
                <button class="tab active" onclick="navigate('#/following')">Подписки</button>
            </div>
            <div class="spinner-wrap"><div class="spinner-ring"></div></div>
        `;

        const resp = await api('GET', '/feed/following');
        if (!resp) return;
        const posts = await resp.json();

        let html = `
            <div class="tabs">
                <button class="tab" onclick="navigate('#/feed')">Для вас</button>
                <button class="tab active" onclick="navigate('#/following')">Подписки</button>
            </div>
        `;
        html += renderPosts(posts);
        app.innerHTML = html;
    }

    async function showProfile(userId) {
        app.innerHTML = `
            <div class="back-bar">
                <button class="back-btn" onclick="history.back()">${ICONS.back}</button>
                <div class="back-bar-info"><h3>Профиль</h3></div>
            </div>
            <div class="spinner-wrap"><div class="spinner-ring"></div></div>
        `;

        const [profileResp, postsResp] = await Promise.all([
            api('GET', '/users/' + userId),
            api('GET', '/users/' + userId + '/posts'),
        ]);

        if (!profileResp || !profileResp.ok) {
            app.innerHTML = '<div class="empty-state">Пользователь не найден</div>';
            return;
        }

        const profile = await profileResp.json();
        const posts = postsResp && postsResp.ok ? await postsResp.json() : [];
        const isMe = currentUser && currentUser.id === profile.id;
        const initial = (profile.username || '?')[0].toUpperCase();

        let html = `
            <div class="back-bar">
                <button class="back-btn" onclick="history.back()">${ICONS.back}</button>
                <div class="back-bar-info">
                    <h3>${esc(profile.username)}</h3>
                    <span>${posts.length} ${pluralize(posts.length, 'пост', 'поста', 'постов')}</span>
                </div>
            </div>
        `;

        // Banner
        html += `<div class="profile-banner"></div>`;

        // Profile info
        html += `<div class="profile-info">`;
        html += `<div class="profile-avatar-wrap">`;

        if (profile.avatar_url) {
            html += `<img class="avatar-lg" src="${profile.avatar_url}">`;
        } else {
            html += `<div class="avatar-placeholder lg">${initial}</div>`;
        }

        if (isMe) {
            html += `
                <div style="display:flex;gap:8px">
                    <button class="btn btn-outline btn-sm" onclick="navigate('#/edit-profile')">Редактировать</button>
                    <label class="btn btn-outline btn-sm" style="cursor:pointer">
                        ${ICONS.image} Аватар
                        <input type="file" accept="image/*" style="display:none" onchange="doUploadAvatar(this)">
                    </label>
                </div>
            `;
        } else if (currentUser) {
            html += profile.is_following
                ? `<button class="btn-follow following" onclick="doToggleFollow(${profile.id}, true)" onmouseenter="this.textContent='Отписаться'" onmouseleave="this.textContent='Подписан'">Подписан</button>`
                : `<button class="btn-follow follow" onclick="doToggleFollow(${profile.id}, false)">Подписаться</button>`;
        }

        html += `</div>`; // avatar-wrap

        html += `<div class="profile-name">${esc(profile.username)}</div>`;
        html += `<div class="profile-handle">@${esc(profile.username.toLowerCase())}</div>`;

        if (profile.bio) {
            html += `<div class="profile-bio">${esc(profile.bio)}</div>`;
        }

        html += `
            <div class="profile-stats-row">
                <span class="profile-stat" onclick="navigate('#/following/${profile.id}')">
                    <strong>${profile.following_count}</strong> подписок
                </span>
                <span class="profile-stat" onclick="navigate('#/followers/${profile.id}')">
                    <strong>${profile.followers_count}</strong> подписчиков
                </span>
            </div>
        `;
        html += `</div>`; // profile-info

        // Tabs for profile posts
        html += `
            <div class="tabs">
                <button class="tab active">Посты</button>
            </div>
        `;

        html += renderPosts(posts);
        app.innerHTML = html;
    }

    function showEditProfile() {
        if (!currentUser) { navigate('#/login'); return; }
        app.innerHTML = `
            <div class="back-bar">
                <button class="back-btn" onclick="navigate('#/profile/${currentUser.id}')">${ICONS.back}</button>
                <div class="back-bar-info"><h3>Редактировать профиль</h3></div>
            </div>
            <div style="padding:16px">
                <div id="msg"></div>
                <div class="form-group">
                    <label>О себе</label>
                    <textarea class="form-input" id="editBio">${esc(currentUser.bio || '')}</textarea>
                </div>
                <div style="display:flex;gap:8px">
                    <button class="btn btn-primary" onclick="doUpdateBio()">Сохранить</button>
                    <button class="btn btn-outline" onclick="navigate('#/profile/${currentUser.id}')">Отмена</button>
                </div>
            </div>
        `;
    }

    async function showUserList(userId, type) {
        const label = type === 'followers' ? 'Подписчики' : 'Подписки';

        app.innerHTML = `
            <div class="back-bar">
                <button class="back-btn" onclick="navigate('#/profile/${userId}')">${ICONS.back}</button>
                <div class="back-bar-info"><h3>${label}</h3></div>
            </div>
            <div class="spinner-wrap"><div class="spinner-ring"></div></div>
        `;

        const resp = await api('GET', '/users/' + userId + '/' + type);
        if (!resp) return;
        const users = await resp.json();

        let html = `
            <div class="back-bar">
                <button class="back-btn" onclick="navigate('#/profile/${userId}')">${ICONS.back}</button>
                <div class="back-bar-info"><h3>${label}</h3></div>
            </div>
        `;

        if (!users || users.length === 0) {
            html += `<div class="empty-state">Пусто</div>`;
        } else {
            html += users.map(u => `
                <div class="user-item" onclick="navigate('#/profile/${u.id}')">
                    ${u.avatar_url ? `<img class="avatar" src="${u.avatar_url}">` : `<div class="avatar avatar-placeholder">${(u.username||'?')[0].toUpperCase()}</div>`}
                    <div style="flex:1;min-width:0">
                        <div style="font-weight:700;font-size:15px">${esc(u.username)}</div>
                        <div style="font-size:14px;color:var(--text-muted)">@${esc(u.username.toLowerCase())}</div>
                        ${u.bio ? `<div style="font-size:14px;color:var(--text-secondary);margin-top:2px">${esc(u.bio)}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }
        app.innerHTML = html;
    }

    async function showComments(postId) {
        app.innerHTML = `
            <div class="back-bar">
                <button class="back-btn" onclick="history.back()">${ICONS.back}</button>
                <div class="back-bar-info"><h3>Комментарии</h3></div>
            </div>
            <div class="spinner-wrap"><div class="spinner-ring"></div></div>
        `;

        const resp = await api('GET', '/posts/' + postId + '/comments');
        if (!resp) return;
        const comments = await resp.json();

        let html = `
            <div class="back-bar">
                <button class="back-btn" onclick="history.back()">${ICONS.back}</button>
                <div class="back-bar-info"><h3>Комментарии</h3></div>
            </div>
        `;

        if (currentUser) {
            html += `
                <div class="compose" style="border-bottom:1px solid var(--border)">
                    <div class="post-left">
                        ${renderAvatar(currentUser, 'avatar')}
                    </div>
                    <div class="compose-right">
                        <textarea placeholder="Написать комментарий..." id="newComment" oninput="autoGrow(this)"></textarea>
                        <div style="display:flex;justify-content:flex-end;margin-top:8px">
                            <button class="btn btn-accent btn-sm" onclick="doCreateComment(${postId})">Ответить</button>
                        </div>
                    </div>
                </div>
            `;
        }

        if (!comments || comments.length === 0) {
            html += '<div class="empty-state">Комментариев пока нет</div>';
        } else {
            html += '<div style="padding:0 16px">';
            comments.forEach(c => {
                html += `
                    <div class="comment">
                        <div class="comment-header">
                            ${c.avatar_url ? `<img class="avatar-sm" src="${c.avatar_url}" style="cursor:pointer" onclick="navigate('#/profile/${c.user_id}')">` : `<div class="avatar-sm avatar-placeholder" style="font-size:11px;cursor:pointer" onclick="navigate('#/profile/${c.user_id}')">${(c.username||'?')[0].toUpperCase()}</div>`}
                            <span class="post-name" onclick="navigate('#/profile/${c.user_id}')" style="font-size:14px">${esc(c.username)}</span>
                            <span class="post-dot">&middot;</span>
                            <span class="post-time" style="font-size:13px">${timeAgo(c.created_at)}</span>
                        </div>
                        <p style="font-size:14px;line-height:1.5;margin-left:36px;color:var(--text-secondary)">${esc(c.content)}</p>
                    </div>
                `;
            });
            html += '</div>';
        }
        app.innerHTML = html;
    }

    // === RENDER HELPERS ===

    function renderAvatar(user, cls = 'avatar') {
        if (user.avatar_url) {
            return `<img class="${cls}" src="${user.avatar_url}" onclick="navigate('#/profile/${user.id}')">`;
        }
        return `<div class="${cls} avatar-placeholder" onclick="navigate('#/profile/${user.id}')">${(user.username||'?')[0].toUpperCase()}</div>`;
    }

    function renderCompose() {
        return `
            <div class="compose">
                <div class="post-left">
                    ${renderAvatar(currentUser, 'avatar')}
                </div>
                <div class="compose-right">
                    <textarea id="newPostText" placeholder="Что нового?" oninput="autoGrow(this)"></textarea>
                    <div class="image-preview" id="imagePreview">
                        <img id="previewImg">
                        <button class="remove-btn" onclick="removeImage()">&times;</button>
                    </div>
                    <div class="compose-toolbar">
                        <div class="compose-actions">
                            <label class="compose-icon" title="Добавить фото">
                                ${ICONS.image}
                                <input type="file" accept="image/*" style="display:none" id="postImage" onchange="previewPostImage(this)">
                            </label>
                        </div>
                        <button class="btn btn-accent btn-sm" onclick="doCreatePost()">Опубликовать</button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderPosts(posts) {
        if (!posts || posts.length === 0) {
            return '<div class="empty-state">Постов пока нет</div>';
        }
        return posts.map(p => {
            const isOwner = currentUser && currentUser.id === p.user_id;
            return `
                <div class="card">
                    <div class="post">
                        <div class="post-left">
                            ${p.avatar_url ? `<img class="avatar" src="${p.avatar_url}" onclick="navigate('#/profile/${p.user_id}')">` : `<div class="avatar avatar-placeholder" onclick="navigate('#/profile/${p.user_id}')">${(p.username||'?')[0].toUpperCase()}</div>`}
                        </div>
                        <div class="post-right">
                            <div class="post-header">
                                <span class="post-name" onclick="navigate('#/profile/${p.user_id}')">${esc(p.username)}</span>
                                <span class="post-handle">@${esc(p.username.toLowerCase())}</span>
                                <span class="post-dot">&middot;</span>
                                <span class="post-time">${timeAgo(p.created_at)}</span>
                                ${isOwner ? `<button class="post-delete-btn" onclick="doDeletePost(${p.id})" title="Удалить" style="margin-left:auto">&times;</button>` : ''}
                            </div>
                            ${p.content ? `<div class="post-content">${linkify(esc(p.content))}</div>` : ''}
                            ${p.image_url ? `<img class="post-image" src="${p.image_url}" onclick="openLightbox('${p.image_url}')">` : ''}
                            <div class="post-actions">
                                <button class="action-btn like ${p.is_liked ? 'liked' : ''}" id="like-${p.id}" onclick="doToggleLike(${p.id}, ${p.is_liked})">
                                    ${ICONS.heart(p.is_liked)}
                                    <span>${p.likes_count || ''}</span>
                                </button>
                                <button class="action-btn comment" onclick="navigate('#/comments/${p.id}')">
                                    ${ICONS.comment}
                                    <span></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // === ACTIONS ===

    async function doRegister() {
        const username = document.getElementById('regUsername').value.trim();
        const email = document.getElementById('regEmail').value.trim();
        const password = document.getElementById('regPassword').value;

        if (!username || !email || !password) { showMsg('Заполните все поля', 'error'); return; }

        const resp = await fetch(API + '/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, email, password }),
        });
        const data = await resp.json();
        if (!resp.ok) { showMsg(data.error || 'Ошибка', 'error'); return; }

        setTokens(data.tokens.access_token, data.tokens.refresh_token);
        setUser(data.user);
        updateNav();
        toast('Добро пожаловать!');
        navigate('#/feed');
    }

    async function doLogin() {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;

        if (!email || !password) { showMsg('Заполните все поля', 'error'); return; }

        const resp = await fetch(API + '/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password }),
        });
        const data = await resp.json();
        if (!resp.ok) { showMsg(data.error || 'Ошибка', 'error'); return; }

        setTokens(data.tokens.access_token, data.tokens.refresh_token);
        setUser(data.user);
        updateNav();
        toast('С возвращением!');
        navigate('#/feed');
    }

    async function doLogout() {
        if (refreshToken) await api('POST', '/auth/logout', { refresh_token: refreshToken });
        accessToken = ''; refreshToken = ''; currentUser = null;
        localStorage.clear();
        updateNav();
        navigate('#/feed');
    }

    async function doCreatePost() {
        const textEl = document.getElementById('newPostText');
        const imageEl = document.getElementById('postImage');
        const content = textEl ? textEl.value.trim() : '';
        const imageFile = imageEl && imageEl.files[0];

        if (!content && !imageFile) return;

        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '...';

        try {
            if (imageFile) {
                const formData = new FormData();
                formData.append('content', content);
                formData.append('image', imageFile);
                const resp = await apiUpload('/posts', formData);
                if (resp && resp.ok) { toast('Опубликовано!'); await showFeed(); }
            } else {
                const resp = await api('POST', '/posts', { content });
                if (resp && resp.ok) { toast('Опубликовано!'); await showFeed(); }
            }
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = 'Опубликовать'; }
        }
    }

    function previewPostImage(input) {
        if (!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const preview = document.getElementById('imagePreview');
            const img = document.getElementById('previewImg');
            if (preview && img) {
                img.src = e.target.result;
                preview.style.display = 'block';
            }
        };
        reader.readAsDataURL(input.files[0]);
    }

    function removeImage() {
        const input = document.getElementById('postImage');
        const preview = document.getElementById('imagePreview');
        if (input) input.value = '';
        if (preview) preview.style.display = 'none';
    }

    function autoGrow(el) {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
    }

    async function doDeletePost(postId) {
        if (!confirm('Удалить пост?')) return;
        const resp = await api('DELETE', '/posts/' + postId);
        if (resp && resp.ok) { toast('Пост удалён'); router(); }
    }

    async function doToggleLike(postId, isLiked) {
        if (!currentUser) { navigate('#/login'); return; }
        const btn = document.getElementById('like-' + postId);
        if (!btn) return;

        const countEl = btn.querySelector('span');
        const count = parseInt(countEl.textContent) || 0;

        if (isLiked) {
            btn.classList.remove('liked', 'animate');
            btn.innerHTML = ICONS.heart(false) + `<span>${Math.max(0, count - 1) || ''}</span>`;
            btn.setAttribute('onclick', `doToggleLike(${postId}, false)`);
            await api('DELETE', '/posts/' + postId + '/like');
        } else {
            btn.classList.add('liked', 'animate');
            btn.innerHTML = ICONS.heart(true) + `<span>${count + 1}</span>`;
            btn.setAttribute('onclick', `doToggleLike(${postId}, true)`);
            await api('POST', '/posts/' + postId + '/like');
            setTimeout(() => btn.classList.remove('animate'), 500);
        }
    }

    async function doCreateComment(postId) {
        const el = document.getElementById('newComment');
        const content = el ? el.value.trim() : '';
        if (!content) return;
        const resp = await api('POST', '/posts/' + postId + '/comments', { content });
        if (resp && resp.ok) { toast('Комментарий добавлен'); await showComments(postId); }
    }

    async function doToggleFollow(userId, isFollowing) {
        if (isFollowing) await api('DELETE', '/users/' + userId + '/follow');
        else await api('POST', '/users/' + userId + '/follow');
        await showProfile(userId);
    }

    async function doUpdateBio() {
        const bio = document.getElementById('editBio').value;
        const resp = await api('PUT', '/users/me', { bio });
        if (resp && resp.ok) {
            const user = await resp.json();
            setUser(user);
            toast('Профиль обновлён');
            navigate('#/profile/' + currentUser.id);
        }
    }

    async function doUploadAvatar(input) {
        if (!input.files[0]) return;
        const formData = new FormData();
        formData.append('avatar', input.files[0]);
        const resp = await apiUpload('/users/me/avatar', formData);
        if (resp && resp.ok) {
            const meResp = await api('GET', '/users/me');
            if (meResp && meResp.ok) setUser(await meResp.json());
            toast('Аватар обновлён');
            await showProfile(currentUser.id);
        }
    }

    function openLightbox(src) {
        const lb = document.createElement('div');
        lb.className = 'lightbox';
        lb.innerHTML = `<img src="${src}">`;
        lb.onclick = () => lb.remove();
        document.body.appendChild(lb);
    }

    // === UTILITIES ===

    function esc(text) {
        if (!text) return '';
        const d = document.createElement('div');
        d.textContent = text;
        return d.innerHTML;
    }

    function linkify(text) {
        return text.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
    }

    function timeAgo(dateStr) {
        const s = Math.floor((new Date() - new Date(dateStr)) / 1000);
        if (s < 60) return 'сейчас';
        if (s < 3600) return Math.floor(s / 60) + ' мин';
        if (s < 86400) return Math.floor(s / 3600) + ' ч';
        if (s < 2592000) return Math.floor(s / 86400) + ' дн';
        return new Date(dateStr).toLocaleDateString('ru', { day: 'numeric', month: 'short' });
    }

    function pluralize(n, one, few, many) {
        const abs = Math.abs(n) % 100;
        const last = abs % 10;
        if (abs > 10 && abs < 20) return many;
        if (last > 1 && last < 5) return few;
        if (last === 1) return one;
        return many;
    }

    function showMsg(text, type) {
        const el = document.getElementById('msg');
        if (el) el.innerHTML = `<div class="message message-${type}">${esc(text)}</div>`;
    }

    function toast(text) {
        const existing = document.querySelector('.toast');
        if (existing) existing.remove();

        const t = document.createElement('div');
        t.className = 'toast';
        t.textContent = text;
        document.body.appendChild(t);

        requestAnimationFrame(() => {
            requestAnimationFrame(() => t.classList.add('show'));
        });

        setTimeout(() => {
            t.classList.remove('show');
            setTimeout(() => t.remove(), 300);
        }, 2500);
    }

    // === INIT ===
    const app = document.getElementById('app');
    updateNav();
    router();
</script>
</body>
</html>
